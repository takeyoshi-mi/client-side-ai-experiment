<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム英日音声翻訳</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8fafc;
            color: #334155;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 32px;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 8px;
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 32px;
            font-weight: 400;
        }

        .status-bar {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
            padding: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
        }

        .status-item {
            flex: 1;
            text-align: center;
        }

        .status-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .status-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-value.active {
            color: #059669;
        }

        .status-value.active::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-value.inactive {
            color: #64748b;
        }

        .status-value.inactive::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
        }

        .status-value.loading {
            color: #d97706;
        }

        .status-value.loading::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
        }

        .control-panel {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }

        button:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .start-btn {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .start-btn:hover:not(:disabled) {
            background: #059669;
            border-color: #059669;
        }

        .start-btn:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        .stop-btn {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .stop-btn:hover:not(:disabled) {
            background: #dc2626;
            border-color: #dc2626;
        }

        .stop-btn:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        .clear-btn {
            background: #f8fafc;
            color: #475569;
            border-color: #e2e8f0;
        }

        .clear-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .translation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        .translation-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            min-height: 180px;
            position: relative;
        }

        .translation-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .language-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #475569;
        }

        .translation-content {
            color: #334155;
            font-size: 1rem;
            line-height: 1.6;
            min-height: 120px;
            font-weight: 400;
        }

        .interim-text {
            color: #94a3b8;
            font-style: italic;
            opacity: 0.9;
        }

        .history-section {
            margin-top: 32px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-section::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-section::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .history-section::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .history-section::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .history-title {
            font-size: 1.125rem;
            color: #1e293b;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .history-text {
            font-size: 0.875rem;
        }

        .history-english {
            color: #64748b;
            line-height: 1.6;
        }

        .history-japanese {
            color: #1e293b;
            font-weight: 500;
            line-height: 1.6;
        }

        .timestamp {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: right;
            margin-top: 8px;
        }

        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .warning-message {
            background: #fefce8;
            border: 1px solid #fde047;
            color: #ca8a04;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .app-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .section-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 24px 0;
        }

        .collapsible-section {
            margin-top: 16px;
        }

        .collapsible-header {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            padding: 8px 0;
            width: 100%;
            text-align: left;
            transition: color 0.2s ease;
        }

        .collapsible-header:hover {
            color: #475569;
        }

        .collapsible-icon {
            transition: transform 0.2s ease;
        }

        .collapsible-icon.expanded {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 400px;
            margin-top: 12px;
        }
        
        .info-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .info-header h2 {
            color: #059669;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .info-header p {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .features {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .feature {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }
        
        .feature-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .feature-content h3 {
            color: #1e293b;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .feature-content p {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .usage-guide {
            text-align: center;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .usage-guide h3 {
            color: #475569;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .usage-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .usage-step {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .usage-arrow {
            color: #64748b;
            font-weight: bold;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 20px;
            }

            .translation-area {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.875rem;
            }

            .control-panel {
                flex-direction: column;
            }

            .history-item {
                grid-template-columns: 1fr;
            }
            
            .app-info {
                padding: 20px;
            }
            
            .feature {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .usage-steps {
                flex-direction: column;
            }
            
            .usage-arrow {
                transform: rotate(90deg);
            }

            .status-bar {
                gap: 16px;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>リアルタイム英日音声翻訳</h1>
        <p class="subtitle">Chrome Prompt APIを使用したローカルでのリアルタイム音声翻訳デモ</p>
        
        <div class="app-info">
            <p style="text-align: center; font-size: 0.875rem; color: #64748b; margin-bottom: 12px;">🔒 完全ローカル処理 | 🤖 Gemini Nano使用</p>
            
            <div class="collapsible-section">
                <button class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span class="collapsible-icon">▶</span>
                    <span>使い方を表示</span>
                </button>
                <div class="collapsible-content">
                    <div class="usage-guide" style="margin-bottom: 16px;">
                        <h4 style="font-size: 0.875rem; color: #1e293b; margin-bottom: 8px; font-weight: 600;">⚙️ 初回セットアップ（1回のみ）</h4>
                        <div class="usage-steps">
                            <span class="usage-step">「AIモデルを準備する」ボタンをクリック</span>
                            <span class="usage-arrow">→</span>
                            <span class="usage-step">AIモデルをダウンロード</span>
                        </div>
                        <p style="margin-top: 6px; font-size: 0.75rem; color: #d97706;">※ 初回利用時は数分かかる場合があります</p>
                    </div>
                    
                    <div class="usage-guide">
                        <h4 style="font-size: 0.875rem; color: #1e293b; margin-bottom: 8px; font-weight: 600;">📋 使い方</h4>
                        <div class="usage-steps">
                            <span class="usage-step">「音声認識を開始」をクリック</span>
                            <span class="usage-arrow">→</span>
                            <span class="usage-step">英語で話す</span>
                            <span class="usage-arrow">→</span>
                            <span class="usage-step">リアルタイム翻訳を確認</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-divider"></div>

        <div id="warning" class="warning-message" style="display: none;">
            ⚠️ <span id="warning-text"></span>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Chrome AI API</div>
                <div id="ai-status" class="status-value inactive">未確認</div>
            </div>
            <div class="status-item">
                <div class="status-label">音声認識</div>
                <div id="speech-status" class="status-value inactive">待機中</div>
            </div>
            <div class="status-item">
                <div class="status-label">AI モデル</div>
                <div id="model-status" class="status-value inactive">未読込</div>
            </div>
        </div>
        <button id="initialize-model-button" class="start-btn" style="display: none; margin-bottom: 15px;">AIモデルを準備する</button>
        
        <div class="control-panel">
            <button id="startBtn" class="start-btn">音声認識を開始</button>
            <button id="stopBtn" class="stop-btn" disabled>停止</button>
            <button id="clearBtn" class="clear-btn">履歴をクリア</button>
        </div>

        <div class="translation-area">
            <div class="translation-box">
                <div class="translation-label">
                    <span class="language-indicator">English</span>
                    音声認識
                </div>
                <div id="englishText" class="translation-content"></div>
            </div>
            <div class="translation-box">
                <div class="translation-label">
                    <span class="language-indicator">日本語</span>
                    AI翻訳
                    <span id="translationLoader" class="loading-indicator" style="display: none;"></span>
                </div>
                <div id="japaneseText" class="translation-content"></div>
            </div>
        </div>

        <div class="history-section">
            <div class="history-title">📝 翻訳履歴</div>
            <div id="history"></div>
        </div>
    </div>

    <script>
        // コラプス機能
        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector('.collapsible-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                button.querySelector('span:last-child').textContent = '使い方を表示';
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                button.querySelector('span:last-child').textContent = '使い方を非表示';
            }
        }

        // グローバル変数
        let recognition = null;
        let languageModelSession = null;
        let translationDebounceTimer = null;
        let translationHistory = [];
        let lastFinalTranscript = '';
        let isTranslating = false;
        let silenceTimer = null;
        let currentSessionText = '';
        let currentSessionTranslation = '';
        let lastActivityTime = 0;

        // DOM要素の取得
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const englishText = document.getElementById('englishText');
        const japaneseText = document.getElementById('japaneseText');
        const historyDiv = document.getElementById('history');
        const aiStatus = document.getElementById('ai-status');
        const speechStatus = document.getElementById('speech-status');
        const modelStatus = document.getElementById('model-status');
        const warningDiv = document.getElementById('warning');
        const warningText = document.getElementById('warning-text');
        const translationLoader = document.getElementById('translationLoader');
        const initButton = document.getElementById('initialize-model-button');

        // 初期化
        async function initialize() {
            // Chrome AI APIの確認
            if (!window.LanguageModel) {
                showWarning('Chrome AI APIが利用できません。Chrome Canary 128以降を使用し、chrome://flags でPrompt APIを有効にしてください。');
                aiStatus.textContent = '利用不可';
                aiStatus.className = 'status-value inactive';
                startBtn.disabled = true;
                return;
            }

            aiStatus.textContent = '利用可能';
            aiStatus.className = 'status-value active';

            // Web Speech APIの確認
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showWarning('Web Speech APIが利用できません。Chrome等の対応ブラウザを使用してください。');
                speechStatus.textContent = '利用不可';
                speechStatus.className = 'status-value inactive';
                startBtn.disabled = true;
                return;
            }

            // マイクアクセス許可状態を確認
            try {
                const permissions = await navigator.permissions.query({ name: 'microphone' });
                if (permissions.state === 'denied') {
                    showWarning('マイクアクセスが拒否されています。ブラウザの設定でマイクアクセスを許可してください。');
                    speechStatus.textContent = 'アクセス拒否';
                    speechStatus.className = 'status-value inactive';
                    startBtn.disabled = true;
                    return;
                } else if (permissions.state === 'prompt') {
                    speechStatus.textContent = '許可待ち';
                    speechStatus.className = 'status-value loading';
                } else {
                    speechStatus.textContent = '利用可能';
                    speechStatus.className = 'status-value active';
                }
            } catch (error) {
                // permissions API が利用できない場合
                speechStatus.textContent = '利用可能';
                speechStatus.className = 'status-value active';
            }

            // AI モデルの利用可能性を確認
            await checkModelAvailability();
        }

        // モデルの利用可能性を確認
        async function checkModelAvailability() {
            try {
                const availability = await window.LanguageModel.availability();
                
                switch (availability) {
                    case 'available':
                        modelStatus.textContent = '利用可能';
                        modelStatus.className = 'status-value active';
                        if (initButton) { initButton.style.display = 'none'; }
                        await createLanguageModelSession();
                        break;
                    case 'downloadable':
                        modelStatus.textContent = 'ダウンロード可能';
                        modelStatus.className = 'status-value loading';
                        showWarning('AI モデルのダウンロードが必要です。初回利用時は時間がかかることがあります。');
                        if (initButton) {
                            initButton.style.display = '';
                            initButton.disabled = false;
                            initButton.textContent = 'AIモデルを準備する';
                        }
                        break;
                    case 'downloading':
                        modelStatus.textContent = 'ダウンロード中';
                        modelStatus.className = 'status-value loading';
                        showWarning('AI モデルをダウンロードしています。しばらくお待ちください。');
                        if (initButton) {
                            initButton.style.display = '';
                            initButton.disabled = false;
                            initButton.textContent = 'AIモデルを準備する';
                        }
                        break;
                    case 'unavailable':
                        modelStatus.textContent = '利用不可';
                        modelStatus.className = 'status-value inactive';
                        showWarning('AI モデルが利用できません。システム要件を確認してください。');
                        startBtn.disabled = true;
                        if (initButton) { initButton.style.display = 'none'; }
                        break;
                }
            } catch (error) {
                console.error('モデル確認エラー:', error);
                modelStatus.textContent = 'エラー';
                modelStatus.className = 'status-value inactive';
                showWarning('モデルの確認中にエラーが発生しました。');
            }
        }

        // Language Model セッションの作成
        async function createLanguageModelSession() {
            try {
                languageModelSession = await window.LanguageModel.create({
                    temperature: 0.3, // 翻訳の精度を高めるため低温度
                    topK: 3,
                    initialPrompts: [
                        {
                            role: 'system',
                            content: 'You are a professional English to Japanese translator. Translate the given English text to natural Japanese. Only output the Japanese translation without any explanation or additional text.'
                        }
                    ],
                    monitor(m) {
                        m.addEventListener('downloadprogress', (e) => {
                            const progress = Math.round((e.loaded / e.total) * 100);
                            modelStatus.textContent = `ダウンロード中 ${progress}%`;
                            modelStatus.className = 'status-value loading';
                        });
                    }
                });

                modelStatus.textContent = '準備完了';
                modelStatus.className = 'status-value active';
                hideWarning();
                if (initButton) {
                    initButton.textContent = '準備完了';
                    initButton.disabled = true;
                    initButton.style.display = 'none';
                }
                console.log('Language Model セッションを作成しました');
            } catch (error) {
                console.error('セッション作成エラー:', error);
                modelStatus.textContent = 'エラー';
                modelStatus.className = 'status-value inactive';
                showWarning('AI モデルの初期化に失敗しました。');
                if (initButton) {
                    initButton.disabled = false;
                    initButton.textContent = 'AIモデルを準備する';
                }
            }
        }

        // 音声認識の設定
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                speechStatus.textContent = '認識中';
                speechStatus.className = 'status-value active';
                console.log('音声認識を開始しました');
            };

            recognition.onend = () => {
                console.log('音声認識が停止しました');
                
                // ユーザーが明示的に停止した場合は再開しない
                if (startBtn.disabled) { // 音声認識がまだアクティブな場合のみ再開
                    speechStatus.textContent = '再開中';
                    speechStatus.className = 'status-value loading';
                    
                    // 自動的に再開（少し遅延を入れる）
                    setTimeout(() => {
                        if (startBtn.disabled) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('再開失敗:', e);
                                // 再開に失敗した場合はボタン状態をリセット
                                startBtn.disabled = false;
                                stopBtn.disabled = true;
                                speechStatus.textContent = '停止';
                                speechStatus.className = 'status-value inactive';
                                showWarning('音声認識の継続に失敗しました。再度開始してください。');
                            }
                        }
                    }, 500);
                } else {
                    speechStatus.textContent = '停止';
                    speechStatus.className = 'status-value inactive';
                }
            };

            recognition.onerror = (event) => {
                console.error('音声認識エラー:', event.error);
                speechStatus.textContent = 'エラー';
                speechStatus.className = 'status-value inactive';
                
                // ボタンの状態を元に戻す
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                switch(event.error) {
                    case 'no-speech':
                        showWarning('音声が検出されませんでした。マイクが正常に動作しているか確認してください。');
                        break;
                    case 'not-allowed':
                        showWarning('マイクへのアクセスが拒否されました。ブラウザの設定でマイクアクセスを許可してください。');
                        speechStatus.textContent = 'アクセス拒否';
                        break;
                    case 'audio-capture':
                        showWarning('マイクでの音声キャプチャに失敗しました。マイクが他のアプリで使用されていないか確認してください。');
                        break;
                    case 'network':
                        showWarning('ネットワークエラーが発生しました。インターネット接続を確認してください。');
                        break;
                    case 'aborted':
                        // ユーザーが停止した場合は警告を表示しない
                        hideWarning();
                        speechStatus.textContent = '停止';
                        break;
                    default:
                        showWarning(`音声認識エラーが発生しました: ${event.error}`);
                        break;
                }
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // 英語テキストの表示を更新
                if (finalTranscript || interimTranscript) {
                    lastActivityTime = Date.now();
                    clearTimeout(silenceTimer);
                }

                if (finalTranscript) {
                    currentSessionText += (currentSessionText ? ' ' : '') + finalTranscript;
                    englishText.innerHTML = currentSessionText;
                    // 最終結果はすぐに翻訳
                    translateText(currentSessionText, false);
                    
                    // 3秒の無音タイマーを設定
                    silenceTimer = setTimeout(() => {
                        saveCurrentSessionToHistory();
                    }, 3000);
                } else if (interimTranscript) {
                    const displayText = currentSessionText + (currentSessionText ? ' ' : '') +
                        '<span class="interim-text">' + interimTranscript + '</span>';
                    englishText.innerHTML = displayText;
                    // 中間結果の翻訳（デバウンシング）
                    debouncedTranslate(currentSessionText + ' ' + interimTranscript, false);
                }
            };
        }

        // デバウンシング付き翻訳
        function debouncedTranslate(text, isFinal) {
            if (!text.trim()) return;
            
            clearTimeout(translationDebounceTimer);
            translationDebounceTimer = setTimeout(() => {
                translateText(text, isFinal);
            }, 300); // 300ms のデバウンシング
        }

        // テキストの翻訳
        async function translateText(text, isFinal) {
            if (!languageModelSession || !text.trim() || isTranslating) return;

            isTranslating = true;
            translationLoader.style.display = 'inline-block';

            try {
                const prompt = `Translate to Japanese: "${text}"`;
                
                // ストリーミング対応の翻訳
                japaneseText.textContent = '';
                const stream = languageModelSession.promptStreaming(prompt);
                
                let fullTranslation = '';
                for await (const chunk of stream) {
                    fullTranslation += chunk; // チャンクを累積
                    japaneseText.textContent = fullTranslation;
                    console.log('Translation chunk:', chunk); // デバッグ用
                }

                currentSessionTranslation = fullTranslation;
                console.log('Final translation saved:', fullTranslation); // デバッグ用
            } catch (error) {
                console.error('翻訳エラー:', error);
                japaneseText.textContent = '翻訳エラーが発生しました';
                currentSessionTranslation = '';
            } finally {
                isTranslating = false;
                translationLoader.style.display = 'none';
            }
        }

        // 履歴に追加
        function addToHistory(english, japanese) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            translationHistory.unshift({
                english: english,
                japanese: japanese,
                timestamp: timestamp
            });

            // 最大10件まで保持
            if (translationHistory.length > 10) {
                translationHistory.pop();
            }

            updateHistoryDisplay();
        }

        // 履歴表示の更新
        function updateHistoryDisplay() {
            if (translationHistory.length === 0) {
                historyDiv.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 0.875rem;">履歴がありません</div>';
                return;
            }

            historyDiv.innerHTML = translationHistory.map(item => `
                <div class="history-item">
                    <div class="history-text">
                        <div class="language-indicator">🇬🇧 English</div>
                        <div class="history-english">${item.english}</div>
                    </div>
                    <div class="history-text">
                        <div class="language-indicator">🇯🇵 日本語</div>
                        <div class="history-japanese">${item.japanese}</div>
                    </div>
                    <div class="timestamp">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // 警告メッセージの表示
        function showWarning(message) {
            warningText.textContent = message;
            warningDiv.style.display = 'block';
        }

        // 警告メッセージの非表示
        function hideWarning() {
            warningDiv.style.display = 'none';
        }

        // イベントリスナー
        if (initButton) {
            initButton.addEventListener('click', async () => {
                try {
                    initButton.disabled = true;
                    initButton.textContent = '準備中...';
                    await createLanguageModelSession();
                } catch (e) {
                }
            });
        }
        // セッションを履歴に保存
        function saveCurrentSessionToHistory() {
            if (currentSessionText.trim() && currentSessionTranslation.trim()) {
                addToHistory(currentSessionText, currentSessionTranslation);
                currentSessionText = '';
                currentSessionTranslation = '';
                englishText.textContent = '';
                japaneseText.textContent = '';
                console.log('セッションを履歴に保存しました');
            }
        }

        startBtn.addEventListener('click', () => {
            try {
                if (!recognition) {
                    setupSpeechRecognition();
                }
                
                recognition.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                currentSessionText = '';
                currentSessionTranslation = '';
                englishText.textContent = '';
                japaneseText.textContent = '';
                clearTimeout(silenceTimer);
                hideWarning();
            } catch (error) {
                console.error('音声認識開始エラー:', error);
                showWarning('音声認識の開始に失敗しました。ブラウザを更新して再度お試しください。');
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });

        stopBtn.addEventListener('click', () => {
            if (recognition) {
                recognition.stop();
            }
            clearTimeout(silenceTimer);
            // 停止時に現在のセッションを履歴に保存
            saveCurrentSessionToHistory();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            speechStatus.textContent = '停止';
            speechStatus.className = 'status-value inactive';
        });

        clearBtn.addEventListener('click', () => {
            translationHistory = [];
            updateHistoryDisplay();
            currentSessionText = '';
            currentSessionTranslation = '';
            englishText.textContent = '';
            japaneseText.textContent = '';
            clearTimeout(silenceTimer);
        });

        // ページ読み込み時に初期化
        window.addEventListener('load', () => {
            initialize();
            updateHistoryDisplay();
        });

        // ページを離れる時にセッションを破棄
        window.addEventListener('beforeunload', () => {
            if (languageModelSession) {
                languageModelSession.destroy();
            }
            if (recognition) {
                recognition.stop();
            }
        });
    </script>
</body>
</html>