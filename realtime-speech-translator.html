<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„É™„Ç¢„É´„Çø„Ç§„É†Ëã±Êó•Èü≥Â£∞ÁøªË®≥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f8fafc;
            color: #334155;
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 32px;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
        }

        h1 {
            color: #1e293b;
            text-align: center;
            margin-bottom: 8px;
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .subtitle {
            text-align: center;
            color: #64748b;
            font-size: 1rem;
            margin-bottom: 32px;
            font-weight: 400;
        }

        .status-bar {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
            padding: 20px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
        }

        .status-item {
            flex: 1;
            text-align: center;
        }

        .status-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .status-value {
            font-weight: 600;
            color: #1e293b;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-value.active {
            color: #059669;
        }

        .status-value.active::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-value.inactive {
            color: #64748b;
        }

        .status-value.inactive::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
        }

        .status-value.loading {
            color: #d97706;
        }

        .status-value.loading::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f59e0b;
        }

        .control-panel {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
        }

        button {
            flex: 1;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            position: relative;
        }

        button:focus {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }

        .start-btn {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .start-btn:hover:not(:disabled) {
            background: #059669;
            border-color: #059669;
        }

        .start-btn:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        .stop-btn {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .stop-btn:hover:not(:disabled) {
            background: #dc2626;
            border-color: #dc2626;
        }

        .stop-btn:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        .clear-btn {
            background: #f8fafc;
            color: #475569;
            border-color: #e2e8f0;
        }

        .clear-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .translation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        .translation-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            min-height: 180px;
            position: relative;
        }

        .translation-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .language-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            color: #475569;
        }

        .translation-content {
            color: #334155;
            font-size: 1rem;
            line-height: 1.6;
            min-height: 120px;
            font-weight: 400;
        }

        .interim-text {
            color: #94a3b8;
            font-style: italic;
            opacity: 0.9;
        }

        .history-section {
            margin-top: 32px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-section::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-section::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .history-section::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .history-section::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .history-title {
            font-size: 1.125rem;
            color: #1e293b;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-item {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            transition: all 0.2s ease;
        }
        
        .history-item:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .history-text {
            font-size: 0.875rem;
        }

        .history-english {
            color: #64748b;
            line-height: 1.6;
        }

        .history-japanese {
            color: #1e293b;
            font-weight: 500;
            line-height: 1.6;
        }

        .timestamp {
            grid-column: 1 / -1;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: right;
            margin-top: 8px;
        }

        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .warning-message {
            background: #fefce8;
            border: 1px solid #fde047;
            color: #ca8a04;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .app-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .section-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 24px 0;
        }

        .collapsible-section {
            margin-top: 16px;
        }

        .collapsible-header {
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
            padding: 8px 0;
            width: 100%;
            text-align: left;
            transition: color 0.2s ease;
        }

        .collapsible-header:hover {
            color: #475569;
        }

        .collapsible-icon {
            transition: transform 0.2s ease;
        }

        .collapsible-icon.expanded {
            transform: rotate(90deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 400px;
            margin-top: 12px;
        }
        
        .info-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .info-header h2 {
            color: #059669;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .info-header p {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .features {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .feature {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }
        
        .feature-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .feature-content h3 {
            color: #1e293b;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .feature-content p {
            color: #64748b;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .usage-guide {
            text-align: center;
            padding: 20px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .usage-guide h3 {
            color: #475569;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .usage-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .usage-step {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .usage-arrow {
            color: #64748b;
            font-weight: bold;
            font-size: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 20px;
            }

            .translation-area {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.875rem;
            }

            .control-panel {
                flex-direction: column;
            }

            .history-item {
                grid-template-columns: 1fr;
            }
            
            .app-info {
                padding: 20px;
            }
            
            .feature {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            
            .usage-steps {
                flex-direction: column;
            }
            
            .usage-arrow {
                transform: rotate(90deg);
            }

            .status-bar {
                gap: 16px;
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>„É™„Ç¢„É´„Çø„Ç§„É†Ëã±Êó•Èü≥Â£∞ÁøªË®≥</h1>
        <p class="subtitle">Chrome Prompt API„Çí‰ΩøÁî®„Åó„Åü„É≠„Éº„Ç´„É´„Åß„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Èü≥Â£∞ÁøªË®≥„Éá„É¢</p>
        
        <div class="app-info">
            <p style="text-align: center; font-size: 0.875rem; color: #64748b; margin-bottom: 12px;">üîí ÂÆåÂÖ®„É≠„Éº„Ç´„É´Âá¶ÁêÜ | ü§ñ Gemini Nano‰ΩøÁî®</p>
            
            <div class="collapsible-section">
                <button class="collapsible-header" onclick="toggleCollapsible(this)">
                    <span class="collapsible-icon">‚ñ∂</span>
                    <span>‰Ωø„ÅÑÊñπ„ÇíË°®Á§∫</span>
                </button>
                <div class="collapsible-content">
                    <div class="usage-guide" style="margin-bottom: 16px;">
                        <h4 style="font-size: 0.875rem; color: #1e293b; margin-bottom: 8px; font-weight: 600;">‚öôÔ∏è ÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÔºà1Âõû„ÅÆ„ÅøÔºâ</h4>
                        <div class="usage-steps">
                            <span class="usage-step">„ÄåAI„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åô„Çã„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ</span>
                            <span class="usage-arrow">‚Üí</span>
                            <span class="usage-step">AI„É¢„Éá„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</span>
                        </div>
                        <p style="margin-top: 6px; font-size: 0.75rem; color: #d97706;">‚Äª ÂàùÂõûÂà©Áî®ÊôÇ„ÅØÊï∞ÂàÜ„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô</p>
                    </div>
                    
                    <div class="usage-guide">
                        <h4 style="font-size: 0.875rem; color: #1e293b; margin-bottom: 8px; font-weight: 600;">üìã ‰Ωø„ÅÑÊñπ</h4>
                        <div class="usage-steps">
                            <span class="usage-step">„ÄåÈü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</span>
                            <span class="usage-arrow">‚Üí</span>
                            <span class="usage-step">Ëã±Ë™û„ÅßË©±„Åô</span>
                            <span class="usage-arrow">‚Üí</span>
                            <span class="usage-step">„É™„Ç¢„É´„Çø„Ç§„É†ÁøªË®≥„ÇíÁ¢∫Ë™ç</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-divider"></div>

        <div id="warning" class="warning-message" style="display: none;">
            ‚ö†Ô∏è <span id="warning-text"></span>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-label">Chrome AI API</div>
                <div id="ai-status" class="status-value inactive">Êú™Á¢∫Ë™ç</div>
            </div>
            <div class="status-item">
                <div class="status-label">Èü≥Â£∞Ë™çË≠ò</div>
                <div id="speech-status" class="status-value inactive">ÂæÖÊ©ü‰∏≠</div>
            </div>
            <div class="status-item">
                <div class="status-label">AI „É¢„Éá„É´</div>
                <div id="model-status" class="status-value inactive">Êú™Ë™≠Ëæº</div>
            </div>
        </div>
        <button id="initialize-model-button" class="start-btn" style="display: none; margin-bottom: 15px;">AI„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åô„Çã</button>
        
        <div class="control-panel">
            <button id="startBtn" class="start-btn">Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã</button>
            <button id="stopBtn" class="stop-btn" disabled>ÂÅúÊ≠¢</button>
            <button id="clearBtn" class="clear-btn">Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢</button>
        </div>

        <div class="translation-area">
            <div class="translation-box">
                <div class="translation-label">
                    <span class="language-indicator">English</span>
                    Èü≥Â£∞Ë™çË≠ò
                </div>
                <div id="englishText" class="translation-content"></div>
            </div>
            <div class="translation-box">
                <div class="translation-label">
                    <span class="language-indicator">Êó•Êú¨Ë™û</span>
                    AIÁøªË®≥
                    <span id="translationLoader" class="loading-indicator" style="display: none;"></span>
                </div>
                <div id="japaneseText" class="translation-content"></div>
            </div>
        </div>

        <div class="history-section">
            <div class="history-title">üìù ÁøªË®≥Â±•Ê≠¥</div>
            <div id="history"></div>
        </div>
    </div>

    <script>
        // „Ç≥„É©„Éó„ÇπÊ©üËÉΩ
        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector('.collapsible-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                button.querySelector('span:last-child').textContent = '‰Ωø„ÅÑÊñπ„ÇíË°®Á§∫';
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
                button.querySelector('span:last-child').textContent = '‰Ωø„ÅÑÊñπ„ÇíÈùûË°®Á§∫';
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let recognition = null;
        let languageModelSession = null;
        let translationDebounceTimer = null;
        let translationHistory = [];
        let lastFinalTranscript = '';
        let isTranslating = false;
        let silenceTimer = null;
        let currentSessionText = '';
        let currentSessionTranslation = '';
        let lastActivityTime = 0;

        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const englishText = document.getElementById('englishText');
        const japaneseText = document.getElementById('japaneseText');
        const historyDiv = document.getElementById('history');
        const aiStatus = document.getElementById('ai-status');
        const speechStatus = document.getElementById('speech-status');
        const modelStatus = document.getElementById('model-status');
        const warningDiv = document.getElementById('warning');
        const warningText = document.getElementById('warning-text');
        const translationLoader = document.getElementById('translationLoader');
        const initButton = document.getElementById('initialize-model-button');

        // ÂàùÊúüÂåñ
        async function initialize() {
            // Chrome AI API„ÅÆÁ¢∫Ë™ç
            if (!window.LanguageModel) {
                showWarning('Chrome AI API„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇChrome Canary 128‰ª•Èôç„Çí‰ΩøÁî®„Åó„ÄÅchrome://flags „ÅßPrompt API„ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                aiStatus.textContent = 'Âà©Áî®‰∏çÂèØ';
                aiStatus.className = 'status-value inactive';
                startBtn.disabled = true;
                return;
            }

            aiStatus.textContent = 'Âà©Áî®ÂèØËÉΩ';
            aiStatus.className = 'status-value active';

            // Web Speech API„ÅÆÁ¢∫Ë™ç
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showWarning('Web Speech API„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇChromeÁ≠â„ÅÆÂØæÂøú„Éñ„É©„Ç¶„Ç∂„Çí‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                speechStatus.textContent = 'Âà©Áî®‰∏çÂèØ';
                speechStatus.className = 'status-value inactive';
                startBtn.disabled = true;
                return;
            }

            // „Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            try {
                const permissions = await navigator.permissions.query({ name: 'microphone' });
                if (permissions.state === 'denied') {
                    showWarning('„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                    speechStatus.textContent = '„Ç¢„ÇØ„Çª„ÇπÊãíÂê¶';
                    speechStatus.className = 'status-value inactive';
                    startBtn.disabled = true;
                    return;
                } else if (permissions.state === 'prompt') {
                    speechStatus.textContent = 'Ë®±ÂèØÂæÖ„Å°';
                    speechStatus.className = 'status-value loading';
                } else {
                    speechStatus.textContent = 'Âà©Áî®ÂèØËÉΩ';
                    speechStatus.className = 'status-value active';
                }
            } catch (error) {
                // permissions API „ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà
                speechStatus.textContent = 'Âà©Áî®ÂèØËÉΩ';
                speechStatus.className = 'status-value active';
            }

            // AI „É¢„Éá„É´„ÅÆÂà©Áî®ÂèØËÉΩÊÄß„ÇíÁ¢∫Ë™ç
            await checkModelAvailability();
        }

        // „É¢„Éá„É´„ÅÆÂà©Áî®ÂèØËÉΩÊÄß„ÇíÁ¢∫Ë™ç
        async function checkModelAvailability() {
            try {
                const availability = await window.LanguageModel.availability();
                
                switch (availability) {
                    case 'available':
                        modelStatus.textContent = 'Âà©Áî®ÂèØËÉΩ';
                        modelStatus.className = 'status-value active';
                        if (initButton) { initButton.style.display = 'none'; }
                        await createLanguageModelSession();
                        break;
                    case 'downloadable':
                        modelStatus.textContent = '„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÂèØËÉΩ';
                        modelStatus.className = 'status-value loading';
                        showWarning('AI „É¢„Éá„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇÂàùÂõûÂà©Áî®ÊôÇ„ÅØÊôÇÈñì„Åå„Åã„Åã„Çã„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                        if (initButton) {
                            initButton.style.display = '';
                            initButton.disabled = false;
                            initButton.textContent = 'AI„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åô„Çã';
                        }
                        break;
                    case 'downloading':
                        modelStatus.textContent = '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠';
                        modelStatus.className = 'status-value loading';
                        showWarning('AI „É¢„Éá„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        if (initButton) {
                            initButton.style.display = '';
                            initButton.disabled = false;
                            initButton.textContent = 'AI„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åô„Çã';
                        }
                        break;
                    case 'unavailable':
                        modelStatus.textContent = 'Âà©Áî®‰∏çÂèØ';
                        modelStatus.className = 'status-value inactive';
                        showWarning('AI „É¢„Éá„É´„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Ç∑„Çπ„ÉÜ„É†Ë¶Å‰ª∂„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        startBtn.disabled = true;
                        if (initButton) { initButton.style.display = 'none'; }
                        break;
                }
            } catch (error) {
                console.error('„É¢„Éá„É´Á¢∫Ë™ç„Ç®„É©„Éº:', error);
                modelStatus.textContent = '„Ç®„É©„Éº';
                modelStatus.className = 'status-value inactive';
                showWarning('„É¢„Éá„É´„ÅÆÁ¢∫Ë™ç‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ');
            }
        }

        // Language Model „Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ‰ΩúÊàê
        async function createLanguageModelSession() {
            try {
                languageModelSession = await window.LanguageModel.create({
                    temperature: 0.3, // ÁøªË®≥„ÅÆÁ≤æÂ∫¶„ÇíÈ´ò„ÇÅ„Çã„Åü„ÇÅ‰ΩéÊ∏©Â∫¶
                    topK: 3,
                    initialPrompts: [
                        {
                            role: 'system',
                            content: 'You are a professional English to Japanese translator. Translate the given English text to natural Japanese. Only output the Japanese translation without any explanation or additional text.'
                        }
                    ],
                    monitor(m) {
                        m.addEventListener('downloadprogress', (e) => {
                            const progress = Math.round((e.loaded / e.total) * 100);
                            modelStatus.textContent = `„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ‰∏≠ ${progress}%`;
                            modelStatus.className = 'status-value loading';
                        });
                    }
                });

                modelStatus.textContent = 'Ê∫ñÂÇôÂÆå‰∫Ü';
                modelStatus.className = 'status-value active';
                hideWarning();
                if (initButton) {
                    initButton.textContent = 'Ê∫ñÂÇôÂÆå‰∫Ü';
                    initButton.disabled = true;
                    initButton.style.display = 'none';
                }
                console.log('Language Model „Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü');
            } catch (error) {
                console.error('„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„Ç®„É©„Éº:', error);
                modelStatus.textContent = '„Ç®„É©„Éº';
                modelStatus.className = 'status-value inactive';
                showWarning('AI „É¢„Éá„É´„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                if (initButton) {
                    initButton.disabled = false;
                    initButton.textContent = 'AI„É¢„Éá„É´„ÇíÊ∫ñÂÇô„Åô„Çã';
                }
            }
        }

        // Èü≥Â£∞Ë™çË≠ò„ÅÆË®≠ÂÆö
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                speechStatus.textContent = 'Ë™çË≠ò‰∏≠';
                speechStatus.className = 'status-value active';
                console.log('Èü≥Â£∞Ë™çË≠ò„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü');
            };

            recognition.onend = () => {
                console.log('Èü≥Â£∞Ë™çË≠ò„ÅåÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
                
                // „É¶„Éº„Ç∂„Éº„ÅåÊòéÁ§∫ÁöÑ„Å´ÂÅúÊ≠¢„Åó„ÅüÂ†¥Âêà„ÅØÂÜçÈñã„Åó„Å™„ÅÑ
                if (startBtn.disabled) { // Èü≥Â£∞Ë™çË≠ò„Åå„Åæ„Å†„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Â†¥Âêà„ÅÆ„ÅøÂÜçÈñã
                    speechStatus.textContent = 'ÂÜçÈñã‰∏≠';
                    speechStatus.className = 'status-value loading';
                    
                    // Ëá™ÂãïÁöÑ„Å´ÂÜçÈñãÔºàÂ∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„ÇãÔºâ
                    setTimeout(() => {
                        if (startBtn.disabled) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('ÂÜçÈñãÂ§±Êïó:', e);
                                // ÂÜçÈñã„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ„Éú„Çø„É≥Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
                                startBtn.disabled = false;
                                stopBtn.disabled = true;
                                speechStatus.textContent = 'ÂÅúÊ≠¢';
                                speechStatus.className = 'status-value inactive';
                                showWarning('Èü≥Â£∞Ë™çË≠ò„ÅÆÁ∂ôÁ∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂ∫¶ÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                            }
                        }
                    }, 500);
                } else {
                    speechStatus.textContent = 'ÂÅúÊ≠¢';
                    speechStatus.className = 'status-value inactive';
                }
            };

            recognition.onerror = (event) => {
                console.error('Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº:', event.error);
                speechStatus.textContent = '„Ç®„É©„Éº';
                speechStatus.className = 'status-value inactive';
                
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÂÖÉ„Å´Êàª„Åô
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                switch(event.error) {
                    case 'no-speech':
                        showWarning('Èü≥Â£∞„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ„Éû„Ç§„ÇØ„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        break;
                    case 'not-allowed':
                        showWarning('„Éû„Ç§„ÇØ„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Éû„Ç§„ÇØ„Ç¢„ÇØ„Çª„Çπ„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        speechStatus.textContent = '„Ç¢„ÇØ„Çª„ÇπÊãíÂê¶';
                        break;
                    case 'audio-capture':
                        showWarning('„Éû„Ç§„ÇØ„Åß„ÅÆÈü≥Â£∞„Ç≠„É£„Éó„ÉÅ„É£„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éû„Ç§„ÇØ„Åå‰ªñ„ÅÆ„Ç¢„Éó„É™„Åß‰ΩøÁî®„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        break;
                    case 'network':
                        showWarning('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                        break;
                    case 'aborted':
                        // „É¶„Éº„Ç∂„Éº„ÅåÂÅúÊ≠¢„Åó„ÅüÂ†¥Âêà„ÅØË≠¶Âëä„ÇíË°®Á§∫„Åó„Å™„ÅÑ
                        hideWarning();
                        speechStatus.textContent = 'ÂÅúÊ≠¢';
                        break;
                    default:
                        showWarning(`Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${event.error}`);
                        break;
                }
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Ëã±Ë™û„ÉÜ„Ç≠„Çπ„Éà„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
                if (finalTranscript || interimTranscript) {
                    lastActivityTime = Date.now();
                    clearTimeout(silenceTimer);
                }

                if (finalTranscript) {
                    currentSessionText += (currentSessionText ? ' ' : '') + finalTranscript;
                    englishText.innerHTML = currentSessionText;
                    // ÊúÄÁµÇÁµêÊûú„ÅØ„Åô„Åê„Å´ÁøªË®≥
                    translateText(currentSessionText, false);
                    
                    // 3Áßí„ÅÆÁÑ°Èü≥„Çø„Ç§„Éû„Éº„ÇíË®≠ÂÆö
                    silenceTimer = setTimeout(() => {
                        saveCurrentSessionToHistory();
                    }, 3000);
                } else if (interimTranscript) {
                    const displayText = currentSessionText + (currentSessionText ? ' ' : '') +
                        '<span class="interim-text">' + interimTranscript + '</span>';
                    englishText.innerHTML = displayText;
                    // ‰∏≠ÈñìÁµêÊûú„ÅÆÁøªË®≥Ôºà„Éá„Éê„Ç¶„É≥„Ç∑„É≥„Ç∞Ôºâ
                    debouncedTranslate(currentSessionText + ' ' + interimTranscript, false);
                }
            };
        }

        // „Éá„Éê„Ç¶„É≥„Ç∑„É≥„Ç∞‰ªò„ÅçÁøªË®≥
        function debouncedTranslate(text, isFinal) {
            if (!text.trim()) return;
            
            clearTimeout(translationDebounceTimer);
            translationDebounceTimer = setTimeout(() => {
                translateText(text, isFinal);
            }, 300); // 300ms „ÅÆ„Éá„Éê„Ç¶„É≥„Ç∑„É≥„Ç∞
        }

        // „ÉÜ„Ç≠„Çπ„Éà„ÅÆÁøªË®≥
        async function translateText(text, isFinal) {
            if (!languageModelSession || !text.trim() || isTranslating) return;

            isTranslating = true;
            translationLoader.style.display = 'inline-block';

            try {
                const prompt = `Translate to Japanese: "${text}"`;
                
                // „Çπ„Éà„É™„Éº„Éü„É≥„Ç∞ÂØæÂøú„ÅÆÁøªË®≥
                japaneseText.textContent = '';
                const stream = languageModelSession.promptStreaming(prompt);
                
                let fullTranslation = '';
                for await (const chunk of stream) {
                    fullTranslation += chunk; // „ÉÅ„É£„É≥„ÇØ„ÇíÁ¥ØÁ©ç
                    japaneseText.textContent = fullTranslation;
                    console.log('Translation chunk:', chunk); // „Éá„Éê„ÉÉ„Ç∞Áî®
                }

                currentSessionTranslation = fullTranslation;
                console.log('Final translation saved:', fullTranslation); // „Éá„Éê„ÉÉ„Ç∞Áî®
            } catch (error) {
                console.error('ÁøªË®≥„Ç®„É©„Éº:', error);
                japaneseText.textContent = 'ÁøªË®≥„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                currentSessionTranslation = '';
            } finally {
                isTranslating = false;
                translationLoader.style.display = 'none';
            }
        }

        // Â±•Ê≠¥„Å´ËøΩÂä†
        function addToHistory(english, japanese) {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            translationHistory.unshift({
                english: english,
                japanese: japanese,
                timestamp: timestamp
            });

            // ÊúÄÂ§ß10‰ª∂„Åæ„Åß‰øùÊåÅ
            if (translationHistory.length > 10) {
                translationHistory.pop();
            }

            updateHistoryDisplay();
        }

        // Â±•Ê≠¥Ë°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateHistoryDisplay() {
            if (translationHistory.length === 0) {
                historyDiv.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 20px; font-size: 0.875rem;">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            historyDiv.innerHTML = translationHistory.map(item => `
                <div class="history-item">
                    <div class="history-text">
                        <div class="language-indicator">üá¨üáß English</div>
                        <div class="history-english">${item.english}</div>
                    </div>
                    <div class="history-text">
                        <div class="language-indicator">üáØüáµ Êó•Êú¨Ë™û</div>
                        <div class="history-japanese">${item.japanese}</div>
                    </div>
                    <div class="timestamp">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆË°®Á§∫
        function showWarning(message) {
            warningText.textContent = message;
            warningDiv.style.display = 'block';
        }

        // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÈùûË°®Á§∫
        function hideWarning() {
            warningDiv.style.display = 'none';
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        if (initButton) {
            initButton.addEventListener('click', async () => {
                try {
                    initButton.disabled = true;
                    initButton.textContent = 'Ê∫ñÂÇô‰∏≠...';
                    await createLanguageModelSession();
                } catch (e) {
                }
            });
        }
        // „Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠ò
        function saveCurrentSessionToHistory() {
            if (currentSessionText.trim() && currentSessionTranslation.trim()) {
                addToHistory(currentSessionText, currentSessionTranslation);
                currentSessionText = '';
                currentSessionTranslation = '';
                englishText.textContent = '';
                japaneseText.textContent = '';
                console.log('„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            }
        }

        startBtn.addEventListener('click', () => {
            try {
                if (!recognition) {
                    setupSpeechRecognition();
                }
                
                recognition.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                currentSessionText = '';
                currentSessionTranslation = '';
                englishText.textContent = '';
                japaneseText.textContent = '';
                clearTimeout(silenceTimer);
                hideWarning();
            } catch (error) {
                console.error('Èü≥Â£∞Ë™çË≠òÈñãÂßã„Ç®„É©„Éº:', error);
                showWarning('Èü≥Â£∞Ë™çË≠ò„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Éñ„É©„Ç¶„Ç∂„ÇíÊõ¥Êñ∞„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ');
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });

        stopBtn.addEventListener('click', () => {
            if (recognition) {
                recognition.stop();
            }
            clearTimeout(silenceTimer);
            // ÂÅúÊ≠¢ÊôÇ„Å´ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂ±•Ê≠¥„Å´‰øùÂ≠ò
            saveCurrentSessionToHistory();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            speechStatus.textContent = 'ÂÅúÊ≠¢';
            speechStatus.className = 'status-value inactive';
        });

        clearBtn.addEventListener('click', () => {
            translationHistory = [];
            updateHistoryDisplay();
            currentSessionText = '';
            currentSessionTranslation = '';
            englishText.textContent = '';
            japaneseText.textContent = '';
            clearTimeout(silenceTimer);
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        window.addEventListener('load', () => {
            initialize();
            updateHistoryDisplay();
        });

        // „Éö„Éº„Ç∏„ÇíÈõ¢„Çå„ÇãÊôÇ„Å´„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÁ†¥Ê£Ñ
        window.addEventListener('beforeunload', () => {
            if (languageModelSession) {
                languageModelSession.destroy();
            }
            if (recognition) {
                recognition.stop();
            }
        });
    </script>
</body>
</html>